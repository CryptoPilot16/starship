<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>STARSHIP RESEARCH ðŸš€</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1118">

  <!-- Favicons -->
  <link rel="icon" href="./csr-favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="./csr-favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./csr-favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./csr-apple-touch-180.png">

  <style>
    :root{
      --bg:#0b1118; --panel:#0f1722; --panel2:#0c1522;
      --muted:#9aa4b2; --text:#e8ebf2; --radius:16px;
      --stroke:rgba(255,255,255,.10); --stroke-strong:rgba(255,255,255,.22);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);
      font:14px/1.45 system-ui,Segoe UI,Inter,Roboto,sans-serif;
      background:
        radial-gradient(1200px 520px at 50% -10%, rgba(150,170,255,.06), transparent 60%),
        radial-gradient(900px 420px at 50% 0%, rgba(255,255,255,.05), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1160px;margin:18px auto 28px;padding:0 16px}
    .muted{color:var(--muted)}
    .caps{text-transform:uppercase;letter-spacing:.18em}

    /* ===== HERO ===== */
    .hero{max-width:1160px;margin:10px auto 8px;padding:0 16px}
    .hero-box{
      position:relative; overflow:hidden; border-radius:18px;
      border:1px solid var(--stroke-strong);
      background:
        radial-gradient(900px 360px at 50% -10%, rgba(255,255,255,.05), transparent 60%),
        #0b1118;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.10), 0 16px 48px rgba(0,0,0,.32);
    }
    .hero-box img{display:block;width:100%;height:auto;border-radius:18px;filter:saturate(105%)}

    /* Header / cards / inputs */
    header{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
      border:1px solid var(--stroke); border-radius:18px; padding:10px 14px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06), 0 10px 35px rgba(0,0,0,.25);
    }
    h1{margin:0;font-size:18px;letter-spacing:.22em;text-transform:uppercase}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border:1px solid var(--stroke); border-radius:var(--radius); padding:14px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06), 0 20px 60px rgba(0,0,0,.30);
    }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,button{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:linear-gradient(180deg,#0e1623,#0b121c);color:var(--text);outline:none
    }

    /* Buttons base */
    .btn{
      cursor:pointer;background:linear-gradient(180deg,#1a2331,#0f1621);
      border:1px solid var(--stroke-strong);
      text-transform:uppercase;letter-spacing:.14em;font-weight:700;font-size:12px
    }
    .btn-ghost{background:linear-gradient(180deg,#101820,#0b1219)}
    /* Metallic highlight + pulse */
    .btn-metal{ background:linear-gradient(180deg,#ffffff,#cfd5db); color:#0a0f14; border-color:rgba(255,255,255,.7); }
    .btn-pulse{ box-shadow:0 0 0 0 rgba(255,255,255,.45); animation:pulse 1.8s infinite; }
    @keyframes pulse{ 0%{box-shadow:0 0 0 0 rgba(255,255,255,.45)} 70%{box-shadow:0 0 0 14px rgba(255,255,255,0)} 100%{box-shadow:0 0 0 0 rgba(255,255,255,0)} }

    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:10px}
    .pill{
      padding:8px 10px;border:1px solid rgba(255,255,255,.18);border-radius:999px;text-align:center;user-select:none;
      background:linear-gradient(180deg,#101a27,#0b131e); box-shadow:inset 0 1px 0 rgba(255,255,255,.05)
    }
    .pill[data-active="true"]{background:linear-gradient(180deg,#1c2a3a,#0c1725);border-color:#dfe3e8;box-shadow:inset 0 1px 0 rgba(255,255,255,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .status{min-height:20px;margin-top:8px}.ok{color:#22c55e}.err{color:#ff6b6b}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px 8px;border-bottom:1px dashed rgba(255,255,255,.06);text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted)}
    .table-wrap{overflow:auto;max-height:70vh;border:1px solid var(--stroke);border-radius:12px}
    a{color:#cfe4ff;text-decoration:none} a:hover{text-decoration:underline}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);font-size:12px;background:rgba(255,255,255,.10)}
    .tiny{font-size:12px;color:var(--muted)}
    @media (max-width:1160px){.grid{grid-template-columns:repeat(3,1fr)}}
  </style>
</head>
<body>

  <!-- HERO -->
  <div class="hero">
    <div class="hero-box">
      <img src="./starship-banner-thin-1920x160.png"
           srcset="./starship-banner-thin-1920x160.png 1920w,
                   ./starship-banner-thin-1500x140.png 1500w"
           sizes="(min-width:1200px) 1160px, 100vw"
           alt="CRYPTO STARSHIP â€” RESEARCH">
    </div>
  </div>

  <div class="wrap">
    <header>
      <h1 class="caps">Crypto Starship ðŸš€ â€” Solana (4h Windows, 60h cap)</h1>
      <div class="muted">Click <b>Refresh</b> â†’ toggle 4h pills â†’ <b>Fetch</b></div>
    </header>

    <section class="card">
      <form id="query-form" onsubmit="return false;">
        <div class="row">
          <div style="min-width:460px;flex:1">
            <label for="token">Token Address
              <span class="tiny">â€¢ Name: <b id="tokenName">â€”</b></span>
            </label>
            <input id="token" />
          </div>

          <div class="row" style="gap:8px">
            <button type="button" id="refreshChart" class="btn btn-metal btn-pulse">Refresh</button>
            <button type="button" id="selectAll" class="btn">Select all</button>
            <button type="button" id="clearAll"  class="btn">Clear</button>
          </div>
        </div>

        <div class="muted" style="margin-top:10px">4h windows (newest first): click pills to toggle selection.</div>
        <div id="candles" class="grid"></div>

        <div class="row" style="margin-top:10px">
          <div style="width:160px">
            <label for="minSol">Min SOL</label>
            <input type="number" id="minSol" step="0.0000001" value="30" placeholder="30" />
          </div>
          <div style="width:160px">
            <label for="maxSol">Max SOL</label>
            <input type="number" id="maxSol" step="0.0000001" value="300" placeholder="300" />
          </div>
          <div style="flex:1"></div>
          <div>
            <label>&nbsp;</label>
            <button type="submit" id="fetchBtn" class="btn">Fetch</button>
          </div>
        </div>

        <div id="statusTop" class="tiny">â€”</div>
        <div id="status" class="status"></div>
      </form>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="table-wrap">
        <table id="results">
          <thead>
            <tr>
              <th>Time (UTC)</th>
              <th>Wallet</th>
              <th>SOL Amount</th>
              <th>Tx</th>
              <th>Dataset</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    /************* constants *************/
    const REALTIME_HOURS = 60; // 60h cap
    const CANDLE_HOURS = 4;
    const NUM_CANDLES = REALTIME_HOURS / CANDLE_HOURS; // 15 windows
    const DEFAULT_MINT = "H8xQ6poBjB9DTPMDTKWzWPrnxu4bDEhybxiouF8Ppump";

    const $ = s => document.querySelector(s);
    const statusEl=$("#status"), statusTop=$("#statusTop"), tbody=$("#tbody"), candlesWrap=$("#candles");
    const tokenInput=$("#token"), tokenNameEl=$("#tokenName"),
          refreshBtn=$("#refreshChart"), fetchBtn=$("#fetchBtn");

    const pad = n => String(n).padStart(2,"0");
    const toLocalISO = d => `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())} ${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}Z`;
    const toInputISO = d => { const x=new Date(d); x.setUTCSeconds(0,0); return x.toISOString().replace(".000",""); };
    const isoCell = ts => { const d=new Date(ts); return isNaN(d)?(ts||""):d.toISOString().replace("T"," ").replace("Z","Z"); };
    const fmt = (n,d=6)=> (n==null||!isFinite(+n))?"":(+n).toLocaleString(undefined,{maximumFractionDigits:d});

    /************* emphasis helpers *************/
    function setRefreshEmphasis(on){
      refreshBtn.classList.toggle("btn-metal", !!on);
      refreshBtn.classList.toggle("btn-pulse", !!on);
    }
    function setFetchEmphasis(on){
      fetchBtn.classList.toggle("btn-metal", !!on);
      fetchBtn.classList.toggle("btn-pulse", !!on);
    }

    /************* token name (best-effort) *************/
    async function resolveTokenName(mint){
      try{
        const r = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${mint}`, {mode:"cors"});
        if(r.ok){ const j=await r.json(); const pair=j?.pairs?.[0]; const base=pair?.baseToken; if(base?.name||base?.symbol) return base.name || base.symbol; }
      }catch{}
      try{
        const r2 = await fetch(`https://public-api.solscan.io/token/meta?tokenAddress=${mint}`, {mode:"cors"});
        if(r2.ok){ const j=await r2.json(); if(j?.name||j?.symbol) return j.name || j.symbol; }
      }catch{}
      return mint.slice(0,6)+"â€¦"+mint.slice(-6);
    }

    /************* pills *************/
    let candles = [];
    function buildCandles(){
      const now=new Date(); now.setUTCMinutes(0,0,0);
      const out=[];
      for(let i=0;i<NUM_CANDLES;i++){
        const till=new Date(now.getTime()-i*CANDLE_HOURS*3600*1000);
        const since=new Date(till.getTime()-CANDLE_HOURS*3600*1000);
        out.push({since,till});
      }
      return out; // newest first
    }
    function renderCandles(){
      candlesWrap.innerHTML="";
      const frag=document.createDocumentFragment();
      candles.forEach((c,idx)=>{
        const div=document.createElement("div");
        div.className="pill"; div.dataset.active="false"; div.dataset.idx=idx;
        div.title = `${toLocalISO(c.since)} â†’ ${toLocalISO(c.till)} (UTC)`;
        div.textContent = `${toLocalISO(c.since).slice(5,16)} â€“ ${toLocalISO(c.till).slice(5,16)}`;
        div.onclick=()=>{ div.dataset.active = (div.dataset.active==="true")?"false":"true"; };
        frag.appendChild(div);
      });
      candlesWrap.appendChild(frag);
    }
    function clearPills(){ candlesWrap.querySelectorAll(".pill").forEach(el=>el.dataset.active="false"); }
    function allPills(){ candlesWrap.querySelectorAll(".pill").forEach(el=>el.dataset.active="true"); }
    function selectedWindows(){
      const idxs=[...candlesWrap.querySelectorAll(".pill[data-active='true']")].map(n=>+n.dataset.idx).sort((x,y)=>x-y);
      return idxs.map(i=>({ since: toInputISO(candles[i].since), till: toInputISO(candles[i].till) }));
    }

    /************* API *************/
    async function callAPI(body){
      const res=await fetch("./api/trades",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
      if(!res.ok){
        let msg=res.statusText;
        try{
          const t=await res.json(); msg=t?.details||t?.error||msg;
          if(t?.bounds){ statusTop.textContent = `Error: ${msg} (Allowed: ${t.bounds.minSince} â†’ ${t.bounds.maxTill})`; }
        }catch{}
        throw new Error(msg);
      }
      return res.json();
    }

    /************* table *************/
    function renderTable(rows){
      tbody.innerHTML="";
      const frag=document.createDocumentFragment();
      rows.forEach(r=>{
        const sig=r.signature||"", link=sig?`https://solscan.io/tx/${sig}`:"";
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${isoCell(r.time)}</td>
          <td>${r.wallet||""}</td>
          <td>${fmt(r.solAmount,6)}</td>
          <td>${sig?`<a href="${link}" target="_blank" rel="noopener noreferrer">${sig.slice(0,10)}â€¦</a>`:""}</td>
          <td><span class="badge">realtime</span></td>`;
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    /************* Refresh *************/
    async function refreshAll(){
      // User clicked Refresh â†’ Fetch should highlight, Refresh loses it
      setRefreshEmphasis(false);

      clearPills();
      candles = buildCandles();
      renderCandles();

      const token=tokenInput.value.trim();
      if(!token){ statusTop.textContent="Enter a token address."; statusTop.className="tiny err"; return; }

      statusTop.textContent="Resolving tokenâ€¦"; statusTop.className="tiny";
      try{
        tokenNameEl.textContent = await resolveTokenName(token);
        statusTop.textContent="Ready â€” toggle 4h pills then Fetch.";
        statusTop.className="tiny ok";
      }catch{
        tokenNameEl.textContent = token.slice(0,6)+"â€¦"+token.slice(-6);
        statusTop.textContent="Ready."; statusTop.className="tiny ok";
      }
      // highlight Fetch after refresh completes
      setFetchEmphasis(true);
    }

    // Fetch selected windows
    $("#fetchBtn").addEventListener("click", async ()=>{
      // turn off Fetch highlight immediately on click
      setFetchEmphasis(false);

      const token=tokenInput.value.trim();
      const minSol=parseFloat($("#minSol").value), maxSol=parseFloat($("#maxSol").value);
      const windows=selectedWindows();
      if(!token){ statusEl.textContent="Enter a token address."; statusEl.className="status err"; return; }
      if(windows.length===0){ statusEl.textContent="Select at least one 4h window (toggle pills)."; statusEl.className="status err"; return; }

      statusEl.textContent="Loadingâ€¦"; statusEl.className="status";
      try{
        const { rows } = await callAPI({ token, windows });
        const filtered = rows.filter(r=>{
          const s=+r.solAmount; if(!isFinite(s)) return true;
          if(!Number.isNaN(minSol) && s<minSol) return false;
          if(!Number.isNaN(maxSol) && s>maxSol) return false;
          return true;
        });
        renderTable(filtered);
        statusEl.textContent=`Loaded ${filtered.length} row(s) from ${windows.length} interval(s).`;
        statusEl.className="status ok";
      }catch(err){
        statusEl.textContent=`Error: ${err.message||err}`; statusEl.className="status err";
      }
    });

    // Buttons
    $("#refreshChart").onclick = ()=> refreshAll();
    $("#selectAll").onclick = ()=> allPills();
    $("#clearAll").onclick  = ()=> clearPills();

    // Initial UI defaults
    $("#token").value = DEFAULT_MINT;
    (async()=>{ $("#tokenName").textContent = await resolveTokenName(DEFAULT_MINT); })();

    // Initial emphasis: highlight Refresh, keep Fetch neutral
    setRefreshEmphasis(true);
    setFetchEmphasis(false);

    // Typing a new token â†’ Refresh highlights again; Fetch neutral
    tokenInput.addEventListener("input", ()=>{
      setRefreshEmphasis(true);
      setFetchEmphasis(false);
      statusTop.textContent="";
    });

    candles = buildCandles();
    renderCandles();
  </script>
</body>
</html>


